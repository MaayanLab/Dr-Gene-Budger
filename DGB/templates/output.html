{% extends "layout.html" %}

{% block content %}

<div class="container">
    <h1>
      <strong>
        Results
      </strong>
    </h1>
    <h1 class="symbol-title">
      <a href="http://amp.pharm.mssm.edu/Harmonizome/gene/{{symbol}}" target="_blank">
        {{ symbol }}
      </a>: {{ expression }}
    </h1>
    <ul class="nav nav-tabs">
      <li class="nav active" role="presentation">
        <a href="#L1000" aria-controls="l1000" role="tab" data-toggle="tab">L1000</a>
      </li>
      <li class="nav" role="presentation">
        <a href="#CREEDS" aria-controls="creeds" role="tab" data-toggle="tab">CREEDS</a>
      </li>
      <li class="nav" role="presentation">
        <a href="#CMAP" aria-controls="cmap" role="tab" data-toggle="tab">CMAP</a>
      </li>
    </ul>

    <div class="tab-content">
      <div role="tabpanel" class="tab-pane active" id="L1000">
        <table id="L1000-table" class="table datatable dn">
          <thead>
            <tr>
              <th>Drug Name</th>
              <th>LINCS sig_id</th>
              <th>Cell Line</th>
              <th>LINCS pert_id</th>
              <th>Time</th>
              <th>Dose</th>
              <th>p&nbsp;&#x2011;&nbsp;value</th>
              <th>q&nbsp;&#x2011;&nbsp;value</th>
              <th>Fold Change</th>
              <th>Specificity</th>
            </tr>
          </thead>

          <tbody>
          {% for result in l1000_results %}
                <tr>
                  <td>
                    <a href="http://amp.pharm.mssm.edu/dmoa/report/{{ result.signature.pert_id }}" target="_blank">
                      {{ result.signature.drug_name }}
                    </a>
                  </td>
                  <td>{{ result.signature.sig_id }}</td>
                  <td>
                    <script>
                      var getCellLineFromSigId = function(sig_id) {
                        return sig_id.split("_")[1];
                      }
                      var sig_id = "{{ result.signature.sig_id|safe }}";
                      var cellLine = getCellLineFromSigId(sig_id);
                      document.write("<span>" + cellLine + "</span>");
                    </script>
                  </td>
                  <td>
                    <a href="http://amp.pharm.mssm.edu/dmoa/report/{{ result.signature.pert_id }}" target="_blank">
                      {{ result.signature.pert_id }}
                    </a>
                  </td>
                  <td>{{ result.signature.pert_time }} {{ result.signature.pert_time_unit }}</td>
                  <td>{{ result.signature.pert_dose }} {{ result.signature.pert_dose_unit }}</td>
                  <td class="p-val">
                    <script>
                      document.write(Number({{ result.p_value }}).toExponential(2));
                    </script>
                    {% if expression is equalto 'Up-Regulate'%}
                      <span class="p-val-dot green-dot" val="{{ result.p_value }}"></span>
                    {% else %}
                      <span class="p-val-dot red-dot" val="{{ result.p_value }}"></span>
                    {% endif %}
                  </td>
                  <td class="q-val">
                    <script>
                      document.write(Number({{ result.q_value }}).toExponential(2));
                    </script>
                  </td>
                  <td class="fold-change">
                    <script>
                      document.write(Number({{ result.fold_change }}).toFixed(3));
                    </script>
                  </td>
                  <td class="specificity">
                    <script>
                      if ({{result.fold_change}} > 0) {
                        document.write(Number(({{ 1/result.signature.n_sig_up_genes }})).toExponential(2));
                      } else {
                        document.write(Number(({{ 1/result.signature.n_sig_down_genes }})).toExponential(2));
                      }
                    </script>
                  </td>
              </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      <div role="tabpanel" class="tab-pane" id="CREEDS">
        <table id="CREEDS-table" class="table datatable dn">
          <thead>
            <tr>
              <th>Drug Name</th>
              <th>CREEDS ID</th>
              <th>GEO ID</th>
              <th>Drugbank ID</th>
              <th>PubChem ID</th>
              <th>p&nbsp;&#x2011;&nbsp;value</th>
              <th>q&nbsp;&#x2011;&nbsp;value</th>
              <th>Fold Change</th>
              <th>Specificity</th>
            </tr>
          </thead>

          <tbody>
          {% for result in creeds_results %}
                <td>{{ result.signature.drug_name }}</td>
                <td>
                  <a href="http://amp.pharm.mssm.edu/CREEDS/api?id={{result.signature.creeds_id}}" target="_blank">
                    {{ result.signature.creeds_id }}
                  </a>
                </td>
                <td>
                  <a href="http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc={{result.signature.geo_id}}" target="_blank">
                    {{ result.signature.geo_id }}
                  </a>
                </td>
                <td>
                  {% if result.signature.drugbank_id != None %}
                    <a href="http://www.drugbank.ca/drugs/{{result.signature.drugbank_id}}" target="_blank">
                      {{ result.signature.drugbank_id }}
                    </a>
                  {% else %}
                    <span>N/A</span>
                  {% endif %}
                </td>
                <td>
                  {% if result.signature.pubchem_id != None %}
                    <a href="https://pubchem.ncbi.nlm.nih.gov/compound/{{result.signature.pubchem_id}}" target="_blank">
                      {{ result.signature.pubchem_id }}
                    </a>
                  {% else %}
                    <span>N/A</span>
                  {% endif %}
                </td>

                <td class="p-val">
                  <script>
                    document.write(Number({{ result.p_value }}).toExponential(2));
                  </script>
                  {% if expression is equalto 'Up-Regulate'%}
                    <span class="p-val-dot green-dot" val="{{ result.p_value }}"></span>
                  {% else %}
                    <span class="p-val-dot red-dot" val="{{ result.p_value }}"></span>
                  {% endif %}
                </td>
                <td class="q-val">
                  <script>
                    document.write(Number({{ result.q_value }}).toExponential(2));
                  </script>
                </td>
                <td class="fold-change">
                  <script>
                    document.write(Number({{ result.fold_change }}).toFixed(3));
                  </script>
                </td>
                <td class="specificity">
                  <script>
                    if ({{result.fold_change}} > 0) {
                      document.write(Number((1/{{ result.signature.n_sig_up_genes }})).toExponential(2));
                    } else {
                      document.write(Number((1/{{ result.signature.n_sig_down_genes }})).toExponential(2));
                    }
                  </script>
                </td>
              </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      <div role="tabpanel" class="tab-pane" id="CMAP">
        <table id="CMAP-table" class="table datatable dn">
          <thead>
            <tr>
              <th>Drug Name</th>
              <th>Cell Line</th>
              <th>Time</th>
              <th>Dose</th>
              <th>p&nbsp;&#x2011;&nbsp;value</th>
              <th>q&nbsp;&#x2011;&nbsp;value</th>
              <th>Fold Change</th>
              <th>Specificity</th>
            </tr>
          </thead>

          <tbody>
          {% for result in cmap_results %}
              <tr>
                <td>{{ result.signature.drug_name }}</td>
                <td>{{ result.signature.cell_name }}</td>
                <td>{{ result.signature.pert_time }} {{ result.signature.pert_time_unit }}</td>
                <td>{{ result.signature.pert_dose }} {{ result.signature.pert_dose_unit }}</td>
                <td class="p-val">
                  <script>
                    document.write(Number({{ result.p_value }}).toExponential(2));
                  </script>
                  {% if expression is equalto 'Up-Regulate'%}
                    <span class="p-val-dot green-dot" val="{{ result.p_value }}"></span>
                  {% else %}
                    <span class="p-val-dot red-dot" val="{{ result.p_value }}"></span>
                  {% endif %}
                </td>
                <td class="q-val">
                  <script>
                    document.write(Number({{ result.q_value }}).toExponential(2));
                  </script>
                </td>
                <td class="fold-change">
                  <script>
                    document.write(Number({{ result.fold_change }}).toFixed(3));
                  </script>
                </td>
                <td class="specificity">
                  <script>
                    if ({{result.fold_change}} > 0) {
                      document.write(Number((1/{{ result.signature.n_sig_up_genes }})).toExponential(2));
                    } else {
                      document.write(Number((1/{{ result.signature.n_sig_down_genes }})).toExponential(2));
                    }
                  </script>
                </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <br>
</div>

<script>
  var CSV = [
    '"1","val1","val2","val3","val4"',
    '"2","val1","val2","val3","val4"',
    '"3","val1","val2","val3","val4"'
  ].join('\n');

  function generateCSV(input) {
    window.URL = window.webkitURL || window.URL;

    var contentType = 'text/csv';

    var csvFile = new Blob([input], {type: contentType});

    var a = document.createElement('a');
    a.download = 'my.csv';
    a.href = window.URL.createObjectURL(csvFile);
    a.textContent = 'Download CSV';

    a.dataset.downloadurl = [contentType, a.download, a.href].join(':');
    document.getElementsByClassName("symbol-title")[0].appendChild(a);
  }

  generateCSV(CSV);
  
  function calculateOpacity(min, max, input) {
    // This function does the negative log of p-val,
    // linearly scales it to a value between 0 and 1, thereby generating opacity
    var negLogMin = Math.log(1/min);
    var negLogMax = Math.log(1/max);
    var ranger = d3.scaleLinear().domain([negLogMin, negLogMax]).range([0, 1]);
    return ranger(input);
  }

  $(document).ready(function() {
    setTimeout(function() {
      $(".p-val-dot").each(function(idx) {
        var min = 0;
        var max = 0;
        var opacity = calculateOpacity(min, max, Number($(this).attr('val')));
        $(this).attr('style', `opacity:${opacity}`)
      });

      $("#L1000-table").dataTable({
        "order": [[7, "asc"]], // sort by q-value by default
        "fnInitComplete": function() {
          $("#L1000-table").removeClass('dn');
        }
      });

      $("#CREEDS-table").dataTable({
        "order": [[6, "asc"]],
        "fnInitComplete": function() {
          $("#CREEDS-table").removeClass('dn');
        }
      });

      $("#CMAP-table").dataTable({
        "order": [[5, "asc"]], // sort by q-value by default
        "fnInitComplete": function() {
          $("#CMAP-table").removeClass('dn');
        }
      });
    }, 0);
  });
</script>
{% endblock %}
